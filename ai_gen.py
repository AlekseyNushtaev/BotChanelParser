import datetime
from openai import AsyncOpenAI
from config import PROXY_API_KEY

client = AsyncOpenAI(
    api_key=PROXY_API_KEY,
    base_url="https://api.proxyapi.ru/openrouter/v1",
)


def prompt_post():
    return """
<Role>
Ты рерайтер, который занимается переработкой постов на политические темы.
</Role>

<Context>
Тебе надо в официально-деловом стиле переработать пост, оставить примерно такое же количество символов.
Перепиши текст, сохраняя основной смысл, но используя другие слова и выражения.
60% слов должно быть другими.
60% структур предложений должны быть другими.
Скорректируй количество эмодзи, где-поменяй их на соответствующие по смыслу.
Пост поступает тебе зачастую с html разметкой для последующего публикования в Telegram-канале.
</Context>

<Instructions>
1. При рерайтинге оставь те же смыслы, которые несет пост.
2. Результат должен быть длиной +/- 20% от входного текста
3. Если в тексте есть html разметка, то перенеси эту разметку в соответствующих местах.
4. Убери при рерайтинге блоки текста, которые напрямую не относятся к содержанию поста, например просьбы подписаться на канал и подобное.
5. Перед отправкой результата обязательно еще раз посмотри, чтобы твоя HTML разметка была корректна (важно чтобы не была Markdown, а именно HTML), если найдешь ошибки - заново переработай текст.
</Instructions>
    """


def prompt_digest():
    return """
<Role>
Ты рерайтер, который составляет красиво оформленный дайджест из нескольких постов.
</Role>

<Context>
Тебе надо в официально-деловом стиле переработать посты, выделить основные мысли и переработать их в красиво оформленный пронумерованный дайджест.
Каждый пост переработай в 1-3 предложения, в которых будет вся суть поста
Скорректируй количество эмодзи, где-поменяй их на соответствующие по смыслу.
Посты поступают тебе зачастую с html разметкой для последующего публикования в Telegram-канале.
</Context>

<Instructions>
1. Озаглавь пост, например - Дайджест на сегодня, Основные новости и т.п.
2. При рерайтинге оставь те же смыслы, которые несет пост.
3. На каждую новость сделай 1-3 предложения.
4. Красиво оформи, можешь добавить соответствующие эмодзи, ключевые слова выдели жирным текстом (разметка HTML для Telegram, использовать теги <b> и <a>, остальные нет)
5. Если в тексте есть html разметка, то перенеси эту разметку в соответствующих местах.
6. Перед отправкой результата обязательно еще раз посмотри, чтобы твоя HTML разметка была корректна (важно чтобы не была Markdown, а именно HTML), если найдешь ошибки - заново переработай текст.
7. Используй в оформлении только теги <a>, </a>, <b>, </b> остальные использовать строго нельзя, если найдешь другие теги - заново переработай текст.
</Instructions>
    """


async def post_gen(text):
    """Асинхронная версия генерации текста через OpenAI"""
    print(datetime.datetime.now())
    try:
        response = await client.chat.completions.create(
            model="deepseek/deepseek-r1",
            messages=[
                {
                    "role": "system",
                    "content": prompt_post()
                },
                {
                    "role": "user",
                    "content": text
                }
            ],
            timeout=60.0  # Устанавливаем таймаут
        )
        print(datetime.datetime.now())
        return response.choices[0].message.content.replace('<br>', '')
    except Exception as e:
        return f"Ошибка при генерации текста: {e}"


async def post_digest(messages):
    """Асинхронная версия генерации текста через OpenAI"""
    print(datetime.datetime.now())
    messages_digest = [{"role": "system", "content": prompt_digest()}] + messages
    try:
        response = await client.chat.completions.create(
            model="deepseek/deepseek-chat",
            messages=messages_digest,
            timeout=60.0  # Устанавливаем таймаут
        )
        print(datetime.datetime.now())
        return response.choices[0].message.content.replace('<br>', '')
    except Exception as e:
        return f"Ошибка при генерации текста: {e}"
